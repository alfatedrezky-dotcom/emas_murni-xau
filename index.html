<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SMC QUANTUM | LIVE ENGINE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --neon: #00ff88; --danger: #ff4444; --gold: #ffd700; --panel: #111; }
        body { background: #000; color: #eee; font-family: sans-serif; margin: 0; padding: 15px; }
        .grid { display: grid; grid-template-columns: 300px 1fr 300px; gap: 10px; }
        .panel { background: var(--panel); border: 1px solid #222; border-radius: 8px; padding: 15px; }
        #price { font-size: 50px; text-align: center; font-weight: bold; margin: 10px 0; }
        .signal { padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 20px; }
        .buy { background: rgba(0,255,136,0.2); color: var(--neon); border: 1px solid var(--neon); }
        .sell { background: rgba(255,68,68,0.2); color: var(--danger); border: 1px solid var(--danger); }
        input { background: #000; border: 1px solid #333; color: #fff; width: 100%; padding: 8px; margin-bottom: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; }
        .scroll { height: 150px; overflow-y: auto; font-size: 12px; border-top: 1px solid #222; margin-top: 10px; }
    </style>
</head>
<body>

<div class="grid">
    <div class="panel">
        <div style="color:var(--gold)">LEDGER ANALYTICS</div>
        <h2 id="balance">Rp 0</h2>
        <input type="text" id="desc" placeholder="Keterangan">
        <input type="number" id="amt" placeholder="Jumlah (Rp)">
        <button style="background:var(--neon); margin-bottom:5px" onclick="addTrans('IN')">INCOME (+)</button>
        <button style="background:var(--danger)" onclick="addTrans('OUT')">EXPENSE (-)</button>
        <div id="hist" class="scroll"></div>
    </div>

    <div class="panel">
        <div id="price">0000.00</div>
        <div id="sig-box" class="signal">SYNCING ENGINE...</div>
        <div id="chart" style="height: 350px;"></div>
    </div>

    <div class="panel">
        <div style="color:var(--gold)">M1 SIGNAL LOG</div>
        <div id="log" class="scroll" style="height: 400px;"></div>
    </div>
</div>

<script>
    // URL DISAMAKAN DENGAN TERMUX ANDA
    const conf = { databaseURL: "https://emas_murni-xau-default-rtdb.firebaseio.com" };
    firebase.initializeApp(conf);
    const db = firebase.database();

    // Chart Setup
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { backgroundColor: '#111', textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } }
    });
    const candle = chart.addCandlestickSeries({ upColor: '#00ff88', downColor: '#ff4444' });

    let lastP = 0;
    let records = JSON.parse(localStorage.getItem('my_fin_v2')) || [];

    // REAL-TIME SYNC ENGINE
    db.ref('live_monitor').on('value', (s) => {
        const data = s.val();
        if(!data) return;

        const p = data.price;
        const priceEl = document.getElementById('price');
        priceEl.innerText = p.toFixed(2);
        priceEl.style.color = p > lastP ? '#00ff88' : '#ff4444';

        // AUTO-SIGNAL LOGIC
        if(lastP > 0 && p !== lastP) {
            const side = p > lastP ? 'BUY' : 'SELL';
            const sigBox = document.getElementById('sig-box');
            sigBox.innerText = side + " CONFIRMED";
            sigBox.className = "signal " + side.toLowerCase();
            
            const log = document.getElementById('log');
            log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${side} @ ${p}</div>` + log.innerHTML;
        }

        candle.update({ time: Math.floor(data.timestamp), open: p, high: p, low: p, close: p });
        lastP = p;
    });

    // FINANCE SYSTEM
    function addTrans(type) {
        const d = document.getElementById('desc').value;
        const a = parseFloat(document.getElementById('amt').value);
        if(!d || !a) return alert("Isi data!");

        records.push({ d, a, type, t: new Date().toLocaleString() });
        localStorage.setItem('my_fin_v2', JSON.stringify(records));
        render();
    }

    function render() {
        let total = 0;
        const h = document.getElementById('hist');
        h.innerHTML = '';
        records.forEach(i => {
            total += (i.type === 'IN' ? i.a : -i.a);
            h.innerHTML = `<div>${i.d}: Rp ${i.a.toLocaleString()} (${i.type})</div>` + h.innerHTML;
        });
        document.getElementById('balance').innerText = "Rp " + total.toLocaleString();
    }
    render();
</script>
</body>
</html>
