<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SMC ULTRA-PRECISION | LIVE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --neon: #00ff88; --danger: #ff4444; --gold: #ffd700; }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 10px; overflow: hidden; }
        .grid { display: grid; grid-template-columns: 300px 1fr 300px; gap: 10px; height: 95vh; }
        .card { background: #0d0d0d; border: 1px solid #222; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; }
        #price { font-size: 45px; font-weight: bold; text-align: center; color: var(--gold); margin-bottom: 5px; }
        .signal-box { padding: 12px; border-radius: 5px; text-align: center; font-weight: bold; border: 1px solid #333; margin-bottom: 10px; transition: 0.3s; }
        .buy { border-color: var(--neon); color: var(--neon); background: rgba(0,255,136,0.1); }
        .sell { border-color: var(--danger); color: var(--danger); background: rgba(255,68,68,0.1); }
        input { background: #111; border: 1px solid #333; color: #fff; padding: 10px; width: 100%; margin-bottom: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; font-weight: bold; border: none; cursor: pointer; border-radius: 5px; }
        .scroll { flex-grow: 1; overflow-y: auto; font-size: 12px; border-top: 1px solid #222; margin-top: 10px; padding-top: 10px; }
    </style>
</head>
<body>

<div class="grid">
    <div class="card">
        <div style="color:var(--gold); font-size: 12px; margin-bottom: 5px;">LEDGER ANALYTICS</div>
        <h2 id="balance" style="margin: 0 0 15px 0;">Rp 0</h2>
        <input type="text" id="desc" placeholder="Keterangan (misal: Jajan)">
        <input type="number" id="amount" placeholder="Jumlah (Rp)">
        <button onclick="addTrans('IN')" style="background:var(--neon); color:#000; margin-bottom:8px;">INCOME (+)</button>
        <button onclick="addTrans('OUT')" style="background:var(--danger); color:#fff;">EXPENSE (-)</button>
        <div id="history" class="scroll"></div>
    </div>

    <div class="card">
        <div id="price">0000.00</div>
        <div id="signal" class="signal-box">WAITING FOR DATA...</div>
        <div id="chart" style="height: 450px;"></div>
    </div>

    <div class="card">
        <div style="color:var(--gold); font-size: 12px; margin-bottom: 10px;">M1 SIGNAL LOG</div>
        <div id="log" class="scroll"></div>
    </div>
</div>

<script>
    // SINKRONISASI DATABASE
    const firebaseConfig = { databaseURL: "https://emas_murni-xau-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Inisialisasi Chart
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { backgroundColor: '#0d0d0d', textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#1a1a1a' }, horzLines: { color: '#1a1a1a' } },
        timeScale: { timeVisible: true, secondsVisible: true }
    });
    const candleSeries = chart.addCandlestickSeries({ upColor: '#00ff88', downColor: '#ff4444' });

    let lastPrice = 0;
    let transactions = JSON.parse(localStorage.getItem('jurnal_data_v5')) || [];

    // DATA LISTENER (Real-Time)
    db.ref('live_monitor').on('value', (snapshot) => {
        const data = snapshot.val();
        if(!data) return;

        const p = data.price;
        const ts = Math.floor(data.timestamp);

        // Update Harga
        const priceEl = document.getElementById('price');
        priceEl.innerText = p.toFixed(2);
        priceEl.style.color = p > lastPrice ? '#00ff88' : '#ff4444';

        // Logika Sinyal & Log
        if(lastPrice > 0 && p !== lastPrice) {
            const side = p > lastPrice ? 'BUY' : 'SELL';
            const sigEl = document.getElementById('signal');
            sigEl.innerText = side + " CONFIRMED";
            sigEl.className = "signal-box " + side.toLowerCase();
            
            const logEl = document.getElementById('log');
            logEl.innerHTML = `<div style="padding:5px 0; border-bottom:1px solid #1a1a1a;">[${new Date().toLocaleTimeString()}] ${side} @ ${p}</div>` + logEl.innerHTML;
        }

        // Update Chart
        candleSeries.update({ time: ts, open: p, high: p, low: p, close: p });
        lastPrice = p;
    });

    // SISTEM JURNAL
    function addTrans(type) {
        const desc = document.getElementById('desc').value;
        const amount = parseFloat(document.getElementById('amount').value);
        if(!desc || isNaN(amount)) return;

        transactions.push({ desc, amount, type, time: new Date().toLocaleString() });
        localStorage.setItem('jurnal_data_v5', JSON.stringify(transactions));
        
        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
        renderJurnal();
    }

    function renderJurnal() {
        let total = 0;
        const histEl = document.getElementById('history');
        histEl.innerHTML = '';
        transactions.forEach(i => {
            total += (i.type === 'IN' ? i.amount : -i.amount);
            histEl.innerHTML = `<div style="margin-bottom:8px;">${i.desc}: <span style="color:${i.type==='IN'?'#00ff88':'#ff4444'}">Rp ${i.amount.toLocaleString()}</span></div>` + histEl.innerHTML;
        });
        document.getElementById('balance').innerText = "Rp " + total.toLocaleString();
    }
    renderJurnal();
</script>
</body>
</html>
